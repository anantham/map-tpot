# Worklog - TPOT Analyzer

## Phase 1.0: Setup & Infrastructure
- [2025-10-14] Initial setup, `codebase_investigator` analysis.
- [2025-10-14] Established `AGENTS.md` and `docs/ROADMAP.md`.
- [2025-12-08] **Architectural Refactoring (Gemini 3 Pro)**
    - **Hierarchy Decomposition**: Split monolithic `src/graph/hierarchy.py` (701 LOC) into a modular package:
        - `models.py`: Dataclasses for clusters/edges.
        - `traversal.py`: Tree navigation logic.
        - `layout.py`: PCA and edge connectivity math.
        - `builder.py`: Main orchestration logic.
    - **API Refactoring**: Refactored `server.py` (God Object, 1119 LOC) into:
        - `src/api/services/`: Dependency-injected `AnalysisManager` and `CacheManager` to replace global state.
        - `src/api/routes/`: Functional slices (Blueprints) for `core`, `graph`, `analysis`, `discovery`, `accounts`.
        - `src/api/server.py`: A lightweight Application Factory pattern (~100 LOC).
    - **Verification**: `verify_setup.py` passed.
- [2025-12-12] **Phase 1.1 (WIP): Account search → teleport → tag single accounts**
    - **Backend (teleport plumbing)**
        - `tpot-analyzer/src/api/cluster_routes.py:296` Parse `focus_leaf` query param and include it in the cache key (`_make_cache_key`) so `/api/clusters` and `/members` stay consistent.
        - `tpot-analyzer/src/graph/hierarchy/builder.py:44` Add `focus_leaf_id` parameter to `build_hierarchical_view` and apply it before greedy expansions.
        - `tpot-analyzer/src/graph/hierarchy/focus.py:1` Add deterministic “reveal leaf by splitting along the path” helper (`reveal_leaf_in_visible_set`) to guarantee a target leaf becomes visible when budget allows.
    - **Backend (search + tagging)**
        - `tpot-analyzer/src/api/routes/accounts.py:69` Add `GET /api/accounts/search?q=` using snapshot metadata for handle/name prefix search (autocomplete semantics).
        - `tpot-analyzer/src/api/routes/accounts.py:103` Add tag CRUD endpoints scoped by `ego`:
            - `GET /api/accounts/<id>/tags`
            - `POST /api/accounts/<id>/tags` with `{tag, polarity: in|not_in}`
            - `DELETE /api/accounts/<id>/tags/<tag>`
            - `GET /api/tags` for autocomplete.
        - `tpot-analyzer/src/data/account_tags.py:1` Introduce SQLite-backed `AccountTagStore` persisted at `tpot-analyzer/data/account_tags.db`.
        - `tpot-analyzer/src/api/routes/accounts.py:200` Add `GET /api/accounts/<id>/teleport_plan` which selects a base cut `n` that guarantees revealing the target leaf within `budget` (returns `focus_leaf` to use in `/api/clusters`).
    - **Frontend (wiring)**
        - `tpot-analyzer/graph-explorer/src/data.js:703` Add `focus_leaf` param propagation to `fetchClusterView` and `fetchClusterMembers`; fix timing propagation so Stage logs can show per-attempt timings.
        - `tpot-analyzer/graph-explorer/src/AccountSearch.jsx:1` Add search dropdown UI that calls `/api/accounts/search` and triggers teleport.
        - `tpot-analyzer/graph-explorer/src/AccountTagPanel.jsx:1` Add “IN / NOT IN” single-account tagging UI backed by the new account tag endpoints.
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:220` Add teleport flow: clear state → apply `teleport_plan` (`visibleTarget` + `focusLeaf`) → auto-explode leaf → center camera on the member node; integrate `AccountTagPanel` in the side panel (`ClusterView.jsx:1115`).
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:98` Add member-node hit testing + highlight/centering hooks so teleport can visually focus the selected account.
    - **Repo hygiene**
        - `.gitignore` Add `tpot-analyzer/data/account_tags.db*` to keep local tag DB/WAL out of git.
    - **Verification**
        - `tpot-analyzer/scripts/verify_search_teleport_tagging.py:1` Add a human-friendly verification script that exercises `/api/clusters`, `/api/accounts/search`, `teleport_plan`, and tag CRUD with ✓/✗ output.
- [2025-12-13] **TDD backfill: regression tests for teleport + tagging**
    - **Backend unit/integration tests**
        - `tpot-analyzer/tests/test_hierarchy_focus_leaf.py:1` Covers deterministic leaf reveal (`reveal_leaf_in_visible_set`) including budget exhaustion behavior.
        - `tpot-analyzer/tests/test_account_tags_store.py:1` Covers `AccountTagStore` CRUD and tag normalization (case-insensitive keys).
        - `tpot-analyzer/tests/test_accounts_search_teleport_tags.py:1` Covers `/api/accounts/search`, `/api/accounts/<id>/teleport_plan`, and tag endpoints using Flask’s test client (no network).
    - **Frontend component tests (Vitest)**
        - `tpot-analyzer/graph-explorer/src/AccountSearch.test.jsx:1` Covers debounce + selection → `onPick`.
        - `tpot-analyzer/graph-explorer/src/AccountTagPanel.test.jsx:1` Covers tag load + add/remove flows with mocked API calls.
- [2025-12-13] **Phase 2.0 (WIP): On-demand cluster tag summary + heuristic suggested label**
    - **Goal / UX**
        - Compute tag summary only when a cluster is selected (keeps `/api/clusters` payload small).
        - Suggested label heuristic uses `score = inCount - notInCount` and picks the top tag with `score > 0`.
    - **Backend**
        - `tpot-analyzer/src/data/account_tags.py:110` Add `AccountTagStore.list_tags_for_accounts(...)` with chunking to avoid SQLite variable limits.
        - `tpot-analyzer/src/api/cluster_routes.py:582` Add `GET /api/clusters/<cluster_id>/tag_summary` returning `tagCounts` + `suggestedLabel` (uses cached view when available).
    - **Frontend**
        - `tpot-analyzer/graph-explorer/src/data.js:876` Add `fetchClusterTagSummary(...)`.
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:525` Fetch tag summary on cluster select + after tag edits; render Tag summary panel and “Apply suggested label”.
    - **Tests + Verification**
        - `tpot-analyzer/tests/test_cluster_tag_summary.py:1` Covers tag summary counts + `ego` requirement.
        - `tpot-analyzer/scripts/verify_search_teleport_tagging.py:317` Extend verification to hit `/tag_summary` and confirm member-tag appears at the cluster level.
- [2025-12-16] **Stabilization: make test suite green + tighten contracts**
    - **Autocomplete/search semantics**
        - `tpot-analyzer/src/api/routes/accounts.py:1` Keep `/api/accounts/search` prefix-only (autocomplete semantics); remove dead `_rank_search_hit`.
        - `tpot-analyzer/tests/test_api_autocomplete.py:1` Align fixtures with documented expectations (5 `eigen*` accounts).
    - **Enricher testability + observability**
        - `tpot-analyzer/src/shadow/enricher.py:1` Fail fast if `policy` isn’t an `EnrichmentPolicy`; add warning logs when scrape-history lookup fails but proceed “fail-open”.
        - `tpot-analyzer/tests/conftest.py:1` Return a real `EnrichmentPolicy` fixture (no `Mock()` truthiness surprises).
        - `tpot-analyzer/tests/test_account_status_tracking.py:1` Use real `EnrichmentPolicy` in HybridShadowEnricher tests.
    - **Result**
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` → `307 passed, 7 skipped` (green).
    - **Dev tooling**
        - `tpot-analyzer/graph-explorer/package.json:1` Add `test:e2e:mock` (auto-starts Vite) and `test:e2e:mock:no-server` for reusing an already-running dev server.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Add a repo-level Playwright runner for mock/full/ui/debug modes.
        - `tpot-analyzer/scripts/verify_browser_binaries.py:1` Add a browser-binary/cache verification script; docs in `tpot-analyzer/docs/diagnostics/BROWSER_BINARIES.md`.
- [2025-12-16] **E2E: lock in Phase 1 loop (mocked)**
    - **UI deep-link correctness**
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:213` Gate URL-sync effect on `urlParsed` so StrictMode mount doesn’t overwrite initial URL params before parsing (fixes flaky deep-link behavior in tests and manual reloads).
    - **Mocked E2E coverage (Playwright)**
        - `tpot-analyzer/graph-explorer/e2e/teleport_tagging_mock.spec.ts:1` Add “search → teleport → tag → tag summary → apply suggested label” regression test with fully mocked backend.
        - `tpot-analyzer/graph-explorer/e2e/cluster_mock.spec.ts:1` Stabilize cluster-view E2E by clicking nodes deterministically via canvas test helpers; add real API-failure assertion (`HTTP 500`).
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:225` Expose `window.__CLUSTER_CANVAS_TEST__` helpers in dev mode only (Playwright uses these for stable node selection).
    - **Runner updates**
        - `tpot-analyzer/graph-explorer/package.json:1` Update mock runner scripts to execute all `e2e/*mock*.spec.ts` tests.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Update mock runner to execute all `e2e/*mock*.spec.ts` tests.
    - **Verification**
        - `cd tpot-analyzer/graph-explorer && npm run test:e2e:mock` (9 passed)
        - `cd tpot-analyzer/graph-explorer && npx vitest run` (7 passed)
- [2025-12-16] **UI polish: force-morph expand/collapse transitions**
    - **Goal**: remove “teleporting” feel when the cluster layout changes by using a short-lived D3 force simulation to morph nodes toward their new positions.
    - **Implementation**
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:384` Replace linear “move-to-target” tweening with a force-directed morph (`forceX/forceY` to target + `forceCollide` + `forceManyBody`) and snap to exact targets at the end for deterministic focus/teleport behavior.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:832` Keep exploded member dots visually attached to their parent cluster during morphs by translating them by the parent’s display delta.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:185` E2E helper `window.__CLUSTER_CANVAS_TEST__` returns *displayed* positions (settled/morphed), keeping Playwright clicks stable while nodes move.
    - **Verification**
        - `cd tpot-analyzer/graph-explorer && npm run test:e2e:mock` (9 passed)
        - `cd tpot-analyzer/graph-explorer && npx vitest run` (7 passed)
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` (307 passed, 7 skipped)
- [2025-12-17] **Observability: request-id correlation + disk-first logs**
    - **Goal**: eliminate “paste logs into chat” by making request timings + correlation easy to inspect via `logs/api.log` and `logs/frontend.log`.
    - **Backend**
        - `tpot-analyzer/src/api/request_context.py:1` Add ContextVar-backed request id (`req_id`) + `RequestIdFilter` for log record injection.
        - `tpot-analyzer/src/api/server.py:57` Add `before_request`/`after_request` hooks:
            - Generate/accept `X-Request-ID` (or `reqId` query) and echo it in the response header.
            - Emit access logs with `dur_ms` per request (skip `/api/log` to `DEBUG` to avoid spam).
        - `tpot-analyzer/src/api/server.py:136` Make `api.log` location stable via `TPOT_LOG_DIR` (defaults to `tpot-analyzer/logs` regardless of CWD); keep file handler at `DEBUG` and include `req=<id>` in the formatter for grepability.
        - `tpot-analyzer/src/api/log_routes.py:1` Write frontend log events to `${TPOT_LOG_DIR}/frontend.log` and include `req_id` in each JSONL entry.
    - **Dev scripts**
        - `tpot-analyzer/scripts/start_dev.sh:7` Default `API_LOG_LEVEL=DEBUG`, `CLUSTER_LOG_LEVEL=DEBUG`, `TPOT_LOG_DIR=$PROJECT_ROOT/logs`; route Vite stdout to `logs/vite.log` so `logs/frontend.log` is reserved for POST `/api/log`.
        - `tpot-analyzer/StartGraphExplorer.command:17` Ensure `TPOT_LOG_DIR` is set for the backend launch path.
    - **Verification & tooling**
        - `tpot-analyzer/scripts/verify_api_observability.py:1` Add a ✓/✗ script that checks `/api/health` + `X-Request-ID` + `api.log` correlation + `/api/log` → `frontend.log`.
        - `tpot-analyzer/scripts/tail_cluster_logs.py:1` Add a tail/filter helper (`--clusters`, `--req <id>`) for `api.log` and `frontend.log`.
    - **Verification**
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` (309 passed, 9 skipped)
        - `cd tpot-analyzer && .venv/bin/python -m scripts.verify_api_observability` (requires backend running)
- [2025-12-17] **Repo hygiene: canonical docs + E2E naming**
    - **Docs canonicalization**
        - Repo root: replace `docs/` with a symlink to `tpot-analyzer/docs/` (keep a single canonical doc tree).
        - Repo root: remove legacy `graph-explorer/` folder (keep only `tpot-analyzer/graph-explorer/`).
    - **E2E consistency (Playwright)**
        - `tpot-analyzer/graph-explorer/e2e/cluster_real.spec.ts:1` Rename from `cluster.spec.ts`; update backend startup instructions to `python -m scripts.start_api_server`.
        - `tpot-analyzer/graph-explorer/playwright.config.ts:1` Update backend-start comment to match `scripts.start_api_server`.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Update full-backend runner to execute `cluster_real.spec.ts`.
        - `tpot-analyzer/graph-explorer/package.json:1` Add `test:e2e:real` convenience script.
        - `tpot-analyzer/docs/TEST_AUDIT.md:1` Update E2E table to reference `cluster_real.spec.ts`.
        - `tpot-analyzer/CODEX_TASK_E2E_TESTS.md:1` Update “Current State” to reference `cluster_real.spec.ts`.
    - **Test suite consolidation**
        - `tpot-analyzer/tests/test_seed_profile_counts.py:1` Move root test into analyzer suite; remove sys.path hacks.
        - `tpot-analyzer/tests/test_shadow_store_migration.py:1` Move root test into analyzer suite; add `TPOT_LEGACY_DB_PATH` override + `@pytest.mark.integration`.
    - **Browser-binary docs**
        - `tpot-analyzer/docs/diagnostics/BROWSER_BINARIES.md:1` Document Playwright system browser usage + `PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1` for restricted-network installs.
        - `tpot-analyzer/docs/FEATURES_INTENT.md:1` Align “Disk-friendly E2E” note with system-browser approach.
    - **Verification**
        - `cd tpot-analyzer && python3 -m pytest -q tests/test_seed_profile_counts.py tests/test_shadow_store_migration.py` → `3 passed, 1 xfailed`
- [2025-12-17] **Bugfix: /api/seeds 500 + GraphExplorer crash**
    - **Root cause**
        - `tpot-analyzer/src/api/routes/accounts.py:329` was returning a Python `set` (`load_seed_candidates()` result) through `jsonify`, causing `TypeError: Object of type set is not JSON serializable` and repeated `GET /api/seeds 500` in the UI.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx:1216` rendered `graphStats.totalNodes`, which could become an array/object when `/api/graph-data` returns `directed_nodes` as a node list → React “Objects are not valid as a React child”.
    - **Fix**
        - `tpot-analyzer/src/api/routes/accounts.py:329` now returns the canonical seed/settings state (`get_seed_state()`), and `POST /api/seeds` supports both settings updates and seed list save/activate.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx:415` normalizes `data.graph.nodes` arrays into `{[id]: node}` maps and coerces `directed_nodes`/`directed_edges`/`undirected_edges` into counts for safe rendering.
        - `tpot-analyzer/graph-explorer/src/data.js:313` logs numeric counts instead of dumping arrays.
    - **Tests & verification**
        - `tpot-analyzer/tests/test_api_seeds_endpoint.py:1` adds unit tests for `/api/seeds` GET/POST.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.test.jsx:1` adds a regression test ensuring GraphExplorer renders summary counts when backend returns `directed_nodes` arrays.
        - `tpot-analyzer/scripts/verify_graph_explorer_boot.py:1` adds a ✓/✗ boot check script for `/api/seeds` and `/api/graph-data`.
    - **Note**
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx` is >300 LOC (monolith); keep future changes minimal and plan a thin-slice decomposition.
- [2025-12-22] **Hybrid zoom diagnostics: scroll-to-expand instrumentation**
    - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:106,1417,1431,1484,1532` Add opt-in HybridZoom debug logging (`?hz_log=1` or `localStorage.hybridZoomLog=1`) capturing wheel inputs, modifier-zoom path, zoom-mode transitions, and centered-node screen diagnostics for hypothesis falsification.
    - `tpot-analyzer/scripts/verify_hybrid_zoom_logging.py:1` Add a ✓/✗ verification script that scans `logs/frontend.log` for HybridZoom diagnostics and summarizes last payloads.
    - `tpot-analyzer/docs/ROADMAP.md:48` Track follow-up to decompose `ClusterCanvas.jsx` into smaller components.
- [2025-12-26] **Self-evaluating expansion with strategy scoring and caching**
    - **Goal / Design**
        - Replace deterministic expansion heuristics with a "self-evaluating" system that tries all applicable strategies and scores their outputs
        - Weights are on **evaluation signals** (size entropy, collapse ratio, fragmentation, edge separation, tag coherence), NOT on strategy selection
        - Enables user-tunable weights to define what "good structure" means
        - Precomputation + caching delivers instant expansion clicks
    - **Backend (expansion scoring)**
        - `tpot-analyzer/src/graph/hierarchy/expansion_scoring.py:1` (NEW, 465 LOC) Structure-aware scoring:
            - `compute_structure_score()` - evaluates expansion outputs on 5 weighted signals
            - `StructureScoreWeights` - user-tunable weights (default equal)
            - `StructureScoreBreakdown` - detailed component scores + human-readable reason
            - `compute_size_entropy()`, `compute_collapse_ratio()`, `compute_fragmentation_ratio()`, `compute_edge_separation_fast()`, `compute_tag_coherence()` - individual signal computations
            - `ScoredStrategy` and `rank_strategies()` for ranking strategies by score
        - `tpot-analyzer/src/graph/hierarchy/expansion_strategy.py:600` Added:
            - `execute_louvain_local()` - local Louvain community detection on induced subgraph
            - `evaluate_all_strategies()` - runs all applicable strategies and scores results
            - `get_best_expansion()` - convenience wrapper returning top-ranked strategy
    - **Backend (expansion caching)**
        - `tpot-analyzer/src/graph/hierarchy/expansion_cache.py:1` (NEW, 277 LOC) Caching infrastructure:
            - `ExpansionCache` - LRU cache with configurable TTL-based expiry
            - `CachedExpansion` - stores ranked strategies with metadata (compute time, member count)
            - `ExpansionPrecomputer` - background thread for ahead-of-time computation
            - `compute_and_cache_expansion()` - on-demand compute + cache
            - `trigger_precompute_for_visible_clusters()` - queue visible clusters for background precompute
        - `tpot-analyzer/src/graph/hierarchy/__init__.py` - exports all new symbols
    - **Tests**
        - `tpot-analyzer/tests/test_expansion_scoring.py:1` (NEW) 23 tests for scoring components
        - `tpot-analyzer/tests/test_expansion_strategy.py:407` Added 10 tests for `evaluate_all_strategies()`
        - `tpot-analyzer/tests/test_expansion_cache.py:1` (NEW) 21 tests for cache infrastructure
    - **Dependencies**
        - Added `python-louvain` package for local community detection
    - **Pending**
        - Integration into `builder.py` to use `compute_and_cache_expansion()` instead of current `should_use_local_expansion()` + `expand_cluster_locally()` pattern

## Upcoming Tasks
1.  **Unit Test Backfill**: The refactor moved code, but existing tests in `test_api.py` are integration tests dependent on a live DB. We need unit tests for the new `services/` and `routes/` that mock the managers.
2.  **Documentation Update**: `docs/BACKEND_IMPLEMENTATION.md` needs to be updated to reflect the new modular architecture.
3.  **Frontend Alignment**: Ensure `graph-explorer` API calls match the new route structure (URLs remained mostly the same, but need verification).
