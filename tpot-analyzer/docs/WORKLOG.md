# Worklog - TPOT Analyzer

## Phase 1.0: Setup & Infrastructure
- [2025-10-14] Initial setup, `codebase_investigator` analysis.
- [2025-10-14] Established `AGENTS.md` and `docs/ROADMAP.md`.
- [2025-12-08] **Architectural Refactoring (Gemini 3 Pro)**
    - **Hierarchy Decomposition**: Split monolithic `src/graph/hierarchy.py` (701 LOC) into a modular package:
        - `models.py`: Dataclasses for clusters/edges.
        - `traversal.py`: Tree navigation logic.
        - `layout.py`: PCA and edge connectivity math.
        - `builder.py`: Main orchestration logic.
    - **API Refactoring**: Refactored `server.py` (God Object, 1119 LOC) into:
        - `src/api/services/`: Dependency-injected `AnalysisManager` and `CacheManager` to replace global state.
        - `src/api/routes/`: Functional slices (Blueprints) for `core`, `graph`, `analysis`, `discovery`, `accounts`.
        - `src/api/server.py`: A lightweight Application Factory pattern (~100 LOC).
    - **Verification**: `verify_setup.py` passed.
- [2025-12-12] **Phase 1.1 (WIP): Account search → teleport → tag single accounts**
    - **Backend (teleport plumbing)**
        - `tpot-analyzer/src/api/cluster_routes.py:296` Parse `focus_leaf` query param and include it in the cache key (`_make_cache_key`) so `/api/clusters` and `/members` stay consistent.
        - `tpot-analyzer/src/graph/hierarchy/builder.py:44` Add `focus_leaf_id` parameter to `build_hierarchical_view` and apply it before greedy expansions.
        - `tpot-analyzer/src/graph/hierarchy/focus.py:1` Add deterministic “reveal leaf by splitting along the path” helper (`reveal_leaf_in_visible_set`) to guarantee a target leaf becomes visible when budget allows.
    - **Backend (search + tagging)**
        - `tpot-analyzer/src/api/routes/accounts.py:69` Add `GET /api/accounts/search?q=` using snapshot metadata for handle/name prefix search (autocomplete semantics).
        - `tpot-analyzer/src/api/routes/accounts.py:103` Add tag CRUD endpoints scoped by `ego`:
            - `GET /api/accounts/<id>/tags`
            - `POST /api/accounts/<id>/tags` with `{tag, polarity: in|not_in}`
            - `DELETE /api/accounts/<id>/tags/<tag>`
            - `GET /api/tags` for autocomplete.
        - `tpot-analyzer/src/data/account_tags.py:1` Introduce SQLite-backed `AccountTagStore` persisted at `tpot-analyzer/data/account_tags.db`.
        - `tpot-analyzer/src/api/routes/accounts.py:200` Add `GET /api/accounts/<id>/teleport_plan` which selects a base cut `n` that guarantees revealing the target leaf within `budget` (returns `focus_leaf` to use in `/api/clusters`).
    - **Frontend (wiring)**
        - `tpot-analyzer/graph-explorer/src/data.js:703` Add `focus_leaf` param propagation to `fetchClusterView` and `fetchClusterMembers`; fix timing propagation so Stage logs can show per-attempt timings.
        - `tpot-analyzer/graph-explorer/src/AccountSearch.jsx:1` Add search dropdown UI that calls `/api/accounts/search` and triggers teleport.
        - `tpot-analyzer/graph-explorer/src/AccountTagPanel.jsx:1` Add “IN / NOT IN” single-account tagging UI backed by the new account tag endpoints.
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:220` Add teleport flow: clear state → apply `teleport_plan` (`visibleTarget` + `focusLeaf`) → auto-explode leaf → center camera on the member node; integrate `AccountTagPanel` in the side panel (`ClusterView.jsx:1115`).
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:98` Add member-node hit testing + highlight/centering hooks so teleport can visually focus the selected account.
    - **Repo hygiene**
        - `.gitignore` Add `tpot-analyzer/data/account_tags.db*` to keep local tag DB/WAL out of git.
    - **Verification**
        - `tpot-analyzer/scripts/verify_search_teleport_tagging.py:1` Add a human-friendly verification script that exercises `/api/clusters`, `/api/accounts/search`, `teleport_plan`, and tag CRUD with ✓/✗ output.
- [2025-12-13] **TDD backfill: regression tests for teleport + tagging**
    - **Backend unit/integration tests**
        - `tpot-analyzer/tests/test_hierarchy_focus_leaf.py:1` Covers deterministic leaf reveal (`reveal_leaf_in_visible_set`) including budget exhaustion behavior.
        - `tpot-analyzer/tests/test_account_tags_store.py:1` Covers `AccountTagStore` CRUD and tag normalization (case-insensitive keys).
        - `tpot-analyzer/tests/test_accounts_search_teleport_tags.py:1` Covers `/api/accounts/search`, `/api/accounts/<id>/teleport_plan`, and tag endpoints using Flask’s test client (no network).
    - **Frontend component tests (Vitest)**
        - `tpot-analyzer/graph-explorer/src/AccountSearch.test.jsx:1` Covers debounce + selection → `onPick`.
        - `tpot-analyzer/graph-explorer/src/AccountTagPanel.test.jsx:1` Covers tag load + add/remove flows with mocked API calls.
- [2025-12-13] **Phase 2.0 (WIP): On-demand cluster tag summary + heuristic suggested label**
    - **Goal / UX**
        - Compute tag summary only when a cluster is selected (keeps `/api/clusters` payload small).
        - Suggested label heuristic uses `score = inCount - notInCount` and picks the top tag with `score > 0`.
    - **Backend**
        - `tpot-analyzer/src/data/account_tags.py:110` Add `AccountTagStore.list_tags_for_accounts(...)` with chunking to avoid SQLite variable limits.
        - `tpot-analyzer/src/api/cluster_routes.py:582` Add `GET /api/clusters/<cluster_id>/tag_summary` returning `tagCounts` + `suggestedLabel` (uses cached view when available).
    - **Frontend**
        - `tpot-analyzer/graph-explorer/src/data.js:876` Add `fetchClusterTagSummary(...)`.
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:525` Fetch tag summary on cluster select + after tag edits; render Tag summary panel and “Apply suggested label”.
    - **Tests + Verification**
        - `tpot-analyzer/tests/test_cluster_tag_summary.py:1` Covers tag summary counts + `ego` requirement.
        - `tpot-analyzer/scripts/verify_search_teleport_tagging.py:317` Extend verification to hit `/tag_summary` and confirm member-tag appears at the cluster level.
- [2025-12-16] **Stabilization: make test suite green + tighten contracts**
    - **Autocomplete/search semantics**
        - `tpot-analyzer/src/api/routes/accounts.py:1` Keep `/api/accounts/search` prefix-only (autocomplete semantics); remove dead `_rank_search_hit`.
        - `tpot-analyzer/tests/test_api_autocomplete.py:1` Align fixtures with documented expectations (5 `eigen*` accounts).
    - **Enricher testability + observability**
        - `tpot-analyzer/src/shadow/enricher.py:1` Fail fast if `policy` isn’t an `EnrichmentPolicy`; add warning logs when scrape-history lookup fails but proceed “fail-open”.
        - `tpot-analyzer/tests/conftest.py:1` Return a real `EnrichmentPolicy` fixture (no `Mock()` truthiness surprises).
        - `tpot-analyzer/tests/test_account_status_tracking.py:1` Use real `EnrichmentPolicy` in HybridShadowEnricher tests.
    - **Result**
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` → `307 passed, 7 skipped` (green).
    - **Dev tooling**
        - `tpot-analyzer/graph-explorer/package.json:1` Add `test:e2e:mock` (auto-starts Vite) and `test:e2e:mock:no-server` for reusing an already-running dev server.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Add a repo-level Playwright runner for mock/full/ui/debug modes.
        - `tpot-analyzer/scripts/verify_browser_binaries.py:1` Add a browser-binary/cache verification script; docs in `tpot-analyzer/docs/diagnostics/BROWSER_BINARIES.md`.
- [2025-12-16] **E2E: lock in Phase 1 loop (mocked)**
    - **UI deep-link correctness**
        - `tpot-analyzer/graph-explorer/src/ClusterView.jsx:213` Gate URL-sync effect on `urlParsed` so StrictMode mount doesn’t overwrite initial URL params before parsing (fixes flaky deep-link behavior in tests and manual reloads).
    - **Mocked E2E coverage (Playwright)**
        - `tpot-analyzer/graph-explorer/e2e/teleport_tagging_mock.spec.ts:1` Add “search → teleport → tag → tag summary → apply suggested label” regression test with fully mocked backend.
        - `tpot-analyzer/graph-explorer/e2e/cluster_mock.spec.ts:1` Stabilize cluster-view E2E by clicking nodes deterministically via canvas test helpers; add real API-failure assertion (`HTTP 500`).
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:225` Expose `window.__CLUSTER_CANVAS_TEST__` helpers in dev mode only (Playwright uses these for stable node selection).
    - **Runner updates**
        - `tpot-analyzer/graph-explorer/package.json:1` Update mock runner scripts to execute all `e2e/*mock*.spec.ts` tests.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Update mock runner to execute all `e2e/*mock*.spec.ts` tests.
    - **Verification**
        - `cd tpot-analyzer/graph-explorer && npm run test:e2e:mock` (9 passed)
        - `cd tpot-analyzer/graph-explorer && npx vitest run` (7 passed)
- [2025-12-16] **UI polish: force-morph expand/collapse transitions**
    - **Goal**: remove “teleporting” feel when the cluster layout changes by using a short-lived D3 force simulation to morph nodes toward their new positions.
    - **Implementation**
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:384` Replace linear “move-to-target” tweening with a force-directed morph (`forceX/forceY` to target + `forceCollide` + `forceManyBody`) and snap to exact targets at the end for deterministic focus/teleport behavior.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:832` Keep exploded member dots visually attached to their parent cluster during morphs by translating them by the parent’s display delta.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:185` E2E helper `window.__CLUSTER_CANVAS_TEST__` returns *displayed* positions (settled/morphed), keeping Playwright clicks stable while nodes move.
    - **Verification**
        - `cd tpot-analyzer/graph-explorer && npm run test:e2e:mock` (9 passed)
        - `cd tpot-analyzer/graph-explorer && npx vitest run` (7 passed)
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` (307 passed, 7 skipped)
- [2025-12-17] **Observability: request-id correlation + disk-first logs**
    - **Goal**: eliminate “paste logs into chat” by making request timings + correlation easy to inspect via `logs/api.log` and `logs/frontend.log`.
    - **Backend**
        - `tpot-analyzer/src/api/request_context.py:1` Add ContextVar-backed request id (`req_id`) + `RequestIdFilter` for log record injection.
        - `tpot-analyzer/src/api/server.py:57` Add `before_request`/`after_request` hooks:
            - Generate/accept `X-Request-ID` (or `reqId` query) and echo it in the response header.
            - Emit access logs with `dur_ms` per request (skip `/api/log` to `DEBUG` to avoid spam).
        - `tpot-analyzer/src/api/server.py:136` Make `api.log` location stable via `TPOT_LOG_DIR` (defaults to `tpot-analyzer/logs` regardless of CWD); keep file handler at `DEBUG` and include `req=<id>` in the formatter for grepability.
        - `tpot-analyzer/src/api/log_routes.py:1` Write frontend log events to `${TPOT_LOG_DIR}/frontend.log` and include `req_id` in each JSONL entry.
    - **Dev scripts**
        - `tpot-analyzer/scripts/start_dev.sh:7` Default `API_LOG_LEVEL=DEBUG`, `CLUSTER_LOG_LEVEL=DEBUG`, `TPOT_LOG_DIR=$PROJECT_ROOT/logs`; route Vite stdout to `logs/vite.log` so `logs/frontend.log` is reserved for POST `/api/log`.
        - `tpot-analyzer/StartGraphExplorer.command:17` Ensure `TPOT_LOG_DIR` is set for the backend launch path.
    - **Verification & tooling**
        - `tpot-analyzer/scripts/verify_api_observability.py:1` Add a ✓/✗ script that checks `/api/health` + `X-Request-ID` + `api.log` correlation + `/api/log` → `frontend.log`.
        - `tpot-analyzer/scripts/tail_cluster_logs.py:1` Add a tail/filter helper (`--clusters`, `--req <id>`) for `api.log` and `frontend.log`.
    - **Verification**
        - `cd tpot-analyzer && .venv/bin/python -m pytest -q` (309 passed, 9 skipped)
        - `cd tpot-analyzer && .venv/bin/python -m scripts.verify_api_observability` (requires backend running)
- [2025-12-17] **Repo hygiene: canonical docs + E2E naming**
    - **Docs canonicalization**
        - Repo root: replace `docs/` with a symlink to `tpot-analyzer/docs/` (keep a single canonical doc tree).
        - Repo root: remove legacy `graph-explorer/` folder (keep only `tpot-analyzer/graph-explorer/`).
    - **E2E consistency (Playwright)**
        - `tpot-analyzer/graph-explorer/e2e/cluster_real.spec.ts:1` Rename from `cluster.spec.ts`; update backend startup instructions to `python -m scripts.start_api_server`.
        - `tpot-analyzer/graph-explorer/playwright.config.ts:1` Update backend-start comment to match `scripts.start_api_server`.
        - `tpot-analyzer/scripts/run_e2e.sh:1` Update full-backend runner to execute `cluster_real.spec.ts`.
        - `tpot-analyzer/graph-explorer/package.json:1` Add `test:e2e:real` convenience script.
        - `tpot-analyzer/docs/TEST_AUDIT.md:1` Update E2E table to reference `cluster_real.spec.ts`.
        - `tpot-analyzer/CODEX_TASK_E2E_TESTS.md:1` Update “Current State” to reference `cluster_real.spec.ts`.
    - **Test suite consolidation**
        - `tpot-analyzer/tests/test_seed_profile_counts.py:1` Move root test into analyzer suite; remove sys.path hacks.
        - `tpot-analyzer/tests/test_shadow_store_migration.py:1` Move root test into analyzer suite; add `TPOT_LEGACY_DB_PATH` override + `@pytest.mark.integration`.
    - **Browser-binary docs**
        - `tpot-analyzer/docs/diagnostics/BROWSER_BINARIES.md:1` Document Playwright system browser usage + `PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1` for restricted-network installs.
        - `tpot-analyzer/docs/FEATURES_INTENT.md:1` Align “Disk-friendly E2E” note with system-browser approach.
    - **Verification**
        - `cd tpot-analyzer && python3 -m pytest -q tests/test_seed_profile_counts.py tests/test_shadow_store_migration.py` → `3 passed, 1 xfailed`
- [2025-12-17] **Bugfix: /api/seeds 500 + GraphExplorer crash**
    - **Root cause**
        - `tpot-analyzer/src/api/routes/accounts.py:329` was returning a Python `set` (`load_seed_candidates()` result) through `jsonify`, causing `TypeError: Object of type set is not JSON serializable` and repeated `GET /api/seeds 500` in the UI.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx:1216` rendered `graphStats.totalNodes`, which could become an array/object when `/api/graph-data` returns `directed_nodes` as a node list → React “Objects are not valid as a React child”.
    - **Fix**
        - `tpot-analyzer/src/api/routes/accounts.py:329` now returns the canonical seed/settings state (`get_seed_state()`), and `POST /api/seeds` supports both settings updates and seed list save/activate.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx:415` normalizes `data.graph.nodes` arrays into `{[id]: node}` maps and coerces `directed_nodes`/`directed_edges`/`undirected_edges` into counts for safe rendering.
        - `tpot-analyzer/graph-explorer/src/data.js:313` logs numeric counts instead of dumping arrays.
    - **Tests & verification**
        - `tpot-analyzer/tests/test_api_seeds_endpoint.py:1` adds unit tests for `/api/seeds` GET/POST.
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.test.jsx:1` adds a regression test ensuring GraphExplorer renders summary counts when backend returns `directed_nodes` arrays.
        - `tpot-analyzer/scripts/verify_graph_explorer_boot.py:1` adds a ✓/✗ boot check script for `/api/seeds` and `/api/graph-data`.
    - **Note**
        - `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx` is >300 LOC (monolith); keep future changes minimal and plan a thin-slice decomposition.
- [2025-12-22] **Hybrid zoom diagnostics: scroll-to-expand instrumentation**
    - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx:106,1417,1431,1484,1532` Add opt-in HybridZoom debug logging (`?hz_log=1` or `localStorage.hybridZoomLog=1`) capturing wheel inputs, modifier-zoom path, zoom-mode transitions, and centered-node screen diagnostics for hypothesis falsification.
    - `tpot-analyzer/scripts/verify_hybrid_zoom_logging.py:1` Add a ✓/✗ verification script that scans `logs/frontend.log` for HybridZoom diagnostics and summarizes last payloads.
    - `tpot-analyzer/docs/ROADMAP.md:48` Track follow-up to decompose `ClusterCanvas.jsx` into smaller components.
- [2025-12-26] **Self-evaluating expansion with strategy scoring and caching**
    - **Goal / Design**
        - Replace deterministic expansion heuristics with a "self-evaluating" system that tries all applicable strategies and scores their outputs
        - Weights are on **evaluation signals** (size entropy, collapse ratio, fragmentation, edge separation, tag coherence), NOT on strategy selection
        - Enables user-tunable weights to define what "good structure" means
        - Precomputation + caching delivers instant expansion clicks
    - **Backend (expansion scoring)**
        - `tpot-analyzer/src/graph/hierarchy/expansion_scoring.py:1` (NEW, 465 LOC) Structure-aware scoring:
            - `compute_structure_score()` - evaluates expansion outputs on 5 weighted signals
            - `StructureScoreWeights` - user-tunable weights (default equal)
            - `StructureScoreBreakdown` - detailed component scores + human-readable reason
            - `compute_size_entropy()`, `compute_collapse_ratio()`, `compute_fragmentation_ratio()`, `compute_edge_separation_fast()`, `compute_tag_coherence()` - individual signal computations
            - `ScoredStrategy` and `rank_strategies()` for ranking strategies by score
        - `tpot-analyzer/src/graph/hierarchy/expansion_strategy.py:600` Added:
            - `execute_louvain_local()` - local Louvain community detection on induced subgraph
            - `evaluate_all_strategies()` - runs all applicable strategies and scores results
            - `get_best_expansion()` - convenience wrapper returning top-ranked strategy
    - **Backend (expansion caching)**
        - `tpot-analyzer/src/graph/hierarchy/expansion_cache.py:1` (NEW, 277 LOC) Caching infrastructure:
            - `ExpansionCache` - LRU cache with configurable TTL-based expiry
            - `CachedExpansion` - stores ranked strategies with metadata (compute time, member count)
            - `ExpansionPrecomputer` - background thread for ahead-of-time computation
            - `compute_and_cache_expansion()` - on-demand compute + cache
            - `trigger_precompute_for_visible_clusters()` - queue visible clusters for background precompute
        - `tpot-analyzer/src/graph/hierarchy/__init__.py` - exports all new symbols
    - **Tests**
        - `tpot-analyzer/tests/test_expansion_scoring.py:1` (NEW) 23 tests for scoring components
        - `tpot-analyzer/tests/test_expansion_strategy.py:407` Added 10 tests for `evaluate_all_strategies()`
        - `tpot-analyzer/tests/test_expansion_cache.py:1` (NEW) 21 tests for cache infrastructure
    - **Dependencies**
        - Added `python-louvain` package for local community detection
    - **Builder integration**
    - `tpot-analyzer/src/graph/hierarchy/builder.py:197` Replaced `should_use_local_expansion()` with `compute_and_cache_expansion()` for clusters >= 10 members
    - Added `local_expansion_strategies` dict to track which strategy was used for each expansion
    - Virtual clusters now include `expansion_strategy` field for UI display (e.g., "louvain", "core_periphery", "tag_split")
    - Falls back to dendrogram expansion if scored expansion produces single cluster

- [2025-12-30] **Test coverage hardening (goodhart audit + steelman plan) — WIP**
    - **Pre-flight review**
        - Read: `tpot-analyzer/docs/TEST_AUDIT.md`, `tpot-analyzer/docs/tasks/fix-goodharted-tests.md`, `tpot-analyzer/docs/TESTING_METHODOLOGY.md`, `tpot-analyzer/docs/ROADMAP.md`, `tpot-analyzer/docs/index.md`.
        - Hypotheses:
            - H1: Logic reimplementation in tests (e.g., ClusterView utilities, skip-coverage logic) allows behavior regressions to pass.
            - H2: Mock-call assertions in enricher orchestration tests hide missing side effects (upserts/metrics).
            - H3: Cache-internal assertions in cluster route tests bypass response contracts and miss payload regressions.
            - H4: Production-data dependencies and skip markers reduce determinism and inflate green counts.
            - H5: Oversized UI modules suppress granular tests; modularity will improve coverage focus.
    - **Completed changes (line numbers)**
        - `tpot-analyzer/scripts/verify_test_inventory.py:1`: add goodhart inventory script with ✓/✗ output + samples.
        - `tpot-analyzer/scripts/verify_backend_intent.py:1`: add backend verification script for fixtures + helper checks.
        - `tpot-analyzer/tests/fixtures/create_test_cache_db.py:1`: deterministic cache.db builder for API tests.
        - `tpot-analyzer/tests/fixtures/__init__.py:1`: mark fixtures as a package for imports.
        - `tpot-analyzer/tests/conftest.py:243`: add `temp_snapshot_dir` fixture wiring SNAPSHOT_DIR/CACHE_DB_PATH.
        - `tpot-analyzer/tests/test_api.py:11`: use deterministic cache fixture + stronger payload assertions.
        - `tpot-analyzer/src/shadow/enricher.py:1168` and `tpot-analyzer/src/shadow/enricher.py:2371`: use + expose `_compute_skip_coverage_percent`.
        - `tpot-analyzer/tests/test_shadow_enricher_utils.py:743`: assert skip coverage via helper (no reimplementation).
        - `tpot-analyzer/tests/test_cluster_routes.py:362`: assert cache hit returns identical payload; label tests use real store.
        - `tpot-analyzer/docs/ROADMAP.md:14`: capture pending test-hardening gaps (shadow enricher + fixture data).
        - `tpot-analyzer/tests/helpers/recording_shadow_store.py:1`: add recording store to assert enrichment side effects without mock-call checks.
        - `tpot-analyzer/tests/helpers/__init__.py:1`: add helper package for test utilities.
        - `tpot-analyzer/tests/test_shadow_enricher_orchestration.py:22`: switch orchestration tests to recording store + persisted outcome assertions.
        - `tpot-analyzer/tests/test_shadow_enricher_orchestration.py:443`: align delta refresh test with list-specific policy (only following refreshes).
        - `tpot-analyzer/src/graph/builder.py:76`: default archive node provenance for graph payloads.
    - **Remaining planned changes**
        - `tpot-analyzer/graph-explorer/src/ClusterView.test.jsx`: remove reimplementation tests, replace with user-flow assertions.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.memoryleak.test.jsx`: make leak checks deterministic via test hooks.
        - `tpot-analyzer/graph-explorer/src/ClusterCanvas.jsx`, `tpot-analyzer/graph-explorer/src/ClusterView.jsx`, `tpot-analyzer/graph-explorer/src/GraphExplorer.jsx`: decompose into <300 LOC modules.
        - `tpot-analyzer/docs/index.md`: update doc index for new ADR/scripts once created.
        - `tpot-analyzer/docs/adr/006-testability-refactor.md` (NEW): record decisions on testability and modularization.
    - **Verification**
        - `cd tpot-analyzer && python3 -m pytest tests/test_shadow_enricher_orchestration.py -q` → ERROR `ModuleNotFoundError: No module named 'sqlalchemy'`.
        - `cd tpot-analyzer && .venv/bin/python -m pytest tests/test_shadow_enricher_orchestration.py tests/test_shadow_enricher_utils.py::TestZeroCoverageEdgeCase tests/test_cluster_routes.py::TestClusterLabelEndpoints tests/test_api.py -q` → `28 passed, 1 warning` (LibreSSL warning).

- [2026-02-09 11:26 UTC] **Bugfix: Discovery crash from hook initialization order (Codex GPT-5)**
    - **Hypothesis**
        - `Discovery` crashes because `useAccountManager` references `fireChange` in a dependency array before `fireChange` is initialized, triggering a Temporal Dead Zone `ReferenceError` during render.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/graph-explorer/src/hooks/useAccountManager.js:26`: move `fireChange` declaration before first use so render-time dependency evaluation cannot read an uninitialized `const`.
        - `tpot-analyzer/graph-explorer/src/hooks/useAccountManager.js:27`: update effect dependency to `[onAccountChange]` so callback-ref sync tracks the real input prop, not the internal notifier.
        - `tpot-analyzer/graph-explorer/src/hooks/useAccountManager.js:66`: change `markAccountPending` dependencies from `onAccountChange` to `fireChange` to match the closure and avoid stale/misleading deps.
    - **Verification**
        - `cd tpot-analyzer/graph-explorer && npm run build` → success (Vite production build completed; existing non-blocking chunk-size/import warnings remain).

- [2026-02-09 11:54 UTC] **Bugfix: `/api/subgraph/discover` 500 from route/signature drift (Codex GPT-5)**
    - **Hypothesis**
        - Discovery route refactor drifted from `src.api.discovery` contracts: `validate_request` tuple output was not unpacked and `discover_subgraph` was invoked without required `graph`/`pagerank_scores`, producing deterministic HTTP 500.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/src/api/routes/discovery.py:22`: add `_load_graph_result()` to restore route-side graph loading (in-memory snapshot -> snapshot loader -> `cache.db` fallback) so discovery has a directed graph input.
        - `tpot-analyzer/src/api/routes/discovery.py:45`: add `_resolve_seed_handles()` to resolve frontend username seeds to graph node ids before discovery scoring.
        - `tpot-analyzer/src/api/routes/discovery.py:71`: fix request validation flow by unpacking `(parsed_request, errors)` and returning structured 400 validation responses.
        - `tpot-analyzer/src/api/routes/discovery.py:108`: compute PageRank and call `discover_subgraph(directed_graph, parsed_request, pagerank_scores)` with the required signature to remove the route-level `TypeError`.
        - `tpot-analyzer/tests/test_api.py:199`: add regression test covering username-seed discovery success path (`POST /api/subgraph/discover` returns ranked payload).
        - `tpot-analyzer/tests/test_api.py:235`: add regression test covering invalid discovery payload path (400 with validation details instead of 500).
    - **Verification**
        - `cd tpot-analyzer && .venv/bin/python -m pytest tests/test_api.py -q` → `9 passed`.

- [2026-02-09 17:24 UTC] **Docs hygiene cleanup pass (Codex GPT-5)**
    - **Hypothesis**
        - Active docs still had stale references to retired scripts/paths and a missing canonical runbook, causing onboarding drift and broken local commands.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/docs/guides/TEST_MODE.md:5`: remove literal legacy script path from active docs while preserving migration guidance.
        - `tpot-analyzer/docs/WORKLOG.md:261`: update stale future-task path from `docs/BACKEND_IMPLEMENTATION.md` to `docs/reference/BACKEND_IMPLEMENTATION.md`.
        - `tpot-analyzer/docs/WORKLOG.md:249`: add this timestamped cleanup entry to preserve doc-hygiene rationale and verification trace.
    - **Verification**
        - `cd tpot-analyzer && python3 -m scripts.verify_docs_hygiene` → `6/6` checks passing.

- [2026-02-09 17:45 UTC] **Docs hygiene cleanup pass #2: historical docs modernization (Codex GPT-5)**
    - **Hypothesis**
        - Historical docs still contained runnable stale commands/scripts (`create_test_fixtures.py`, `start_test_backend.sh`, `run_all_tests.sh`, `scripts/api_server.py`) that could mislead operators despite canonical docs being fixed.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/docs/tasks/E2E_TESTS.md:36`: add modernization note with current runnable fixture/bootstrap/backend commands.
        - `tpot-analyzer/docs/tasks/E2E_TESTS.md:76`: mark legacy task-script filenames as historical/superseded and map to current implementations.
        - `tpot-analyzer/docs/tasks/E2E_TESTS.md:339`: replace stale fixture/backend verification commands with `create_test_cache_db` bootstrap + `scripts.start_api_server` workflow.
        - `tpot-analyzer/docs/archive/BUGFIXES.md:5`: add historical context banner clarifying current backend entrypoint.
        - `tpot-analyzer/docs/archive/BUGFIXES.md:119`: update backend checklist command to `.venv/bin/python -m scripts.start_api_server`.
        - `tpot-analyzer/docs/index.md:58`: add explicit historical-note bullets for `docs/tasks/E2E_TESTS.md` and `docs/archive/BUGFIXES.md`.
    - **Verification**
        - `cd tpot-analyzer && rg -n "python scripts/create_test_fixtures\\.py|\\.venv/bin/python3 scripts/api_server\\.py" docs/tasks/E2E_TESTS.md docs/archive/BUGFIXES.md` → no direct stale runnable commands remain.
        - `cd tpot-analyzer && python3 -m scripts.verify_docs_hygiene` → `6/6` checks passing.

- [2026-02-09 17:55 UTC] **Docs hygiene cleanup pass #3: CI gate + broad historical sweep (Codex GPT-5)**
    - **Hypothesis**
        - Docs hygiene checks should run in CI, and historical-doc drift should be enforced across all `docs/tasks/*.md` and `docs/archive/*.md`, not only two specific files.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/.github/workflows/test.yml:19`: add `Verify docs hygiene` step so PRs fail when docs drift regressions are introduced.
        - `tpot-analyzer/scripts/verify_docs_hygiene.py:43`: expand historical sweep to all markdown files under `docs/tasks/` and `docs/archive/`.
        - `tpot-analyzer/scripts/verify_docs_hygiene.py:154`: add contextualization check so legacy script references are required to be marked as historical/superseded.
        - `tpot-analyzer/docs/PLAYBOOK.md:122`: add `Docs Release Checklist` with required verification and doc-index/worklog hygiene steps.
    - **Verification**
        - `cd tpot-analyzer && python3 -m scripts.verify_docs_hygiene` → `9/9` checks passing.
        - `cd tpot-analyzer && rg -n "api_server\\.py|create_test_fixtures\\.py|start_test_backend\\.sh|run_all_tests\\.sh" docs/tasks docs/archive` → only contextualized historical/superseded references remain.

- [2026-02-09 18:12 UTC] **Phase A-D sprint: discovery reliability + API contracts + service tests (Codex GPT-5)**
    - **Hypothesis**
        - Discovery had edge-case contract drift (non-object JSON shape handling, unknown seed reporting, debug cache leakage), and frontend contract paths required explicit backend parity and repeatable verification tooling.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/src/api/routes/discovery.py:45`: extend seed resolver to return unresolved inputs so unknown handles can be surfaced deterministically.
        - `tpot-analyzer/src/api/routes/discovery.py:90`: fix request-shape validation to reject non-object JSON bodies instead of coercing to `{}`.
        - `tpot-analyzer/src/api/routes/discovery.py:128`: return `NO_VALID_SEEDS` with concrete `unknown_handles` when no valid seeds remain after resolution.
        - `tpot-analyzer/src/api/discovery.py:75`: add `debug` into discovery cache key to prevent debug payload leakage across requests.
        - `tpot-analyzer/tests/test_discovery_endpoint_matrix.py:42`: add discovery regression matrix for seed normalization, unknown-seed behavior, request-shape validation, caching, and pagination.
        - `tpot-analyzer/scripts/verify_discovery_endpoint.py:70`: add human-friendly discovery verifier (`✓/✗`, metrics, next steps).
        - `tpot-analyzer/scripts/restart_and_smoke_backend.sh:1`: add backend restart + discovery smoke helper for local operator workflows.
        - `tpot-analyzer/src/api/services/signal_feedback_store.py:21`: add in-memory feedback service for discovery signal feedback and quality aggregation.
        - `tpot-analyzer/src/api/server.py:106`: inject `SIGNAL_FEEDBACK_STORE` into app config for route access.
        - `tpot-analyzer/src/api/routes/analysis.py:123`: add `/api/metrics/performance` contract endpoint used by frontend API wrappers.
        - `tpot-analyzer/src/api/routes/analysis.py:171`: add `/api/signals/feedback` and `/api/signals/quality` endpoints to match Discovery UI calls.
        - `tpot-analyzer/src/api/services/cache_manager.py:48`: expose cache-size helpers for performance diagnostics endpoint.
        - `tpot-analyzer/tests/test_api_contract_routes.py:18`: add contract tests for new performance/signals endpoints.
        - `tpot-analyzer/tests/test_signal_feedback_store.py:7`: add service behavior tests for feedback aggregation math.
        - `tpot-analyzer/tests/test_cache_manager.py:7`: add service behavior tests for graph/discovery cache storage + clear semantics.
        - `tpot-analyzer/scripts/verify_api_contracts.py:75`: add frontend/backend API route parity verifier.
        - `tpot-analyzer/scripts/verify_api_services_tests.py:29`: add route/service regression verification bundle script.
        - `tpot-analyzer/.github/workflows/test.yml:22`: add API contract verification step in CI.
        - `tpot-analyzer/docs/PLAYBOOK.md:72`: document new discovery/API verification commands.
        - `tpot-analyzer/docs/ROADMAP.md:18`: mark discovery regression verifier and API contract verifier work as implemented.
    - **Verification**
        - `cd tpot-analyzer && .venv/bin/python -m pytest tests/test_api_contract_routes.py tests/test_discovery_endpoint_matrix.py tests/test_api.py::test_subgraph_discover_endpoint_resolves_username_seed tests/test_api.py::test_subgraph_discover_endpoint_rejects_invalid_payload -q` → `14 passed`.
        - `cd tpot-analyzer && .venv/bin/python -m pytest tests/test_cache_manager.py tests/test_signal_feedback_store.py tests/test_api_contract_routes.py tests/test_discovery_endpoint_matrix.py -q` → `18 passed`.
        - `cd tpot-analyzer && .venv/bin/python -m scripts.verify_api_services_tests` → regression bundle passed (18 tests).
        - `cd tpot-analyzer && .venv/bin/python -m scripts.verify_api_contracts` → `Contract gaps: 0`.
    - **Constraints**
        - Local sandbox denied port binding for live backend start (`Operation not permitted`) while validating `scripts/restart_and_smoke_backend.sh`; static/syntax checks and test-client verification were used instead.

- [2026-02-09 23:17 UTC] **Recent-activity + twitterapi.io subset verifier (Codex GPT-5)**
    - **Hypothesis**
        - Given current X app gating on follows endpoints, post recency/cadence is still high-signal and available.
        - We need an external relationship-audit comparator to quantify whether local `shadow_edge` is complete, incorrect, or a strict subset for sampled accounts.
    - **Changes (line numbers + why)**
        - `tpot-analyzer/scripts/fetch_recent_activity.py:1` (NEW): adds batched `search/recent` harvesting for selected accounts; computes `last_tweet_at`, 7d/30d volume, median/mean post gap, engagement means, and logs request/rate-limit + estimated Post:Read spend.
        - `tpot-analyzer/scripts/verify_shadow_subset_against_twitterapiio.py:1` (NEW): adds subset audit against `twitterapi.io` followers/followings endpoints with explicit overlap/coverage/precision metrics and missing/extra samples per account.
        - `tpot-analyzer/docs/ROADMAP.md:39` records follow-up for standardizing third-party relationship-audit key wiring and adapter behavior.
    - **Verification**
        - `cd tpot-analyzer && .venv/bin/python scripts/fetch_recent_activity.py --usernames adityaarpitha eigenrobot --dry-run` → query batching preview succeeded.
        - `cd tpot-analyzer && .venv/bin/python scripts/verify_shadow_subset_against_twitterapiio.py --sample-size 1` → expected key-missing diagnostic with concrete env var names.
        - `cd tpot-analyzer && .venv/bin/python - <<'PY' ... ast.parse(...) ... PY` → syntax parse passed for both new scripts.
    - **Discovered constraints**
        - `tpot-analyzer/.env` currently includes `X_BEARER_TOKEN` but no `twitterapi.io` key variable; verifier now fails loudly with remediation steps.
        - Live X tests continue to show follows endpoint enrollment gating for the current app/token.

## Upcoming Tasks
1.  **Unit Test Backfill**: The refactor moved code, but existing tests in `test_api.py` are integration tests dependent on a live DB. We need unit tests for the new `services/` and `routes/` that mock the managers.
2.  **Documentation Update**: `docs/reference/BACKEND_IMPLEMENTATION.md` needs to be updated to reflect the new modular architecture.
3.  **Frontend Alignment**: Ensure `graph-explorer` API calls match the new route structure (URLs remained mostly the same, but need verification).
